<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Landing Zone Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        
        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.assistant {
            background-color: white;
            border: 1px solid #dee2e6;
        }
        
        .network-status {
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .status-healthy { color: #28a745; }
        .status-degraded { color: #ffc107; }
        .status-unhealthy { color: #dc3545; }
        
        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading {
            display: none;
        }
        
        .typing-indicator {
            display: none;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-robot me-2"></i>
                AI Landing Zone Chat
            </span>
            <div class="navbar-nav ms-auto">
                <span class="nav-item">
                    <span class="nav-link" id="networkStatus">
                        <i class="fas fa-circle-notch fa-spin me-1"></i>
                        Checking network...
                    </span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Sidebar with sessions -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Chat Sessions</h6>
                        <button class="btn btn-sm btn-primary" onclick="createNewSession()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="session-list" id="sessionList">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Network Status Panel -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Network Status</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="runNetworkTest()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="networkDetails">
                            <div class="text-center">
                                <i class="fas fa-circle-notch fa-spin"></i>
                                <div>Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main chat area -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0" id="chatTitle">Select or create a chat session</h5>
                    </div>
                    <div class="card-body">
                        <div class="chat-container" id="chatContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Welcome to AI Landing Zone Chat!</p>
                                <p>Start a new conversation or select an existing session.</p>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            <i class="fas fa-robot me-2"></i>
                            AI is typing...
                        </div>
                        
                        <div class="input-group mt-3">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Type your message..." 
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentSessionId = null;
        let sessions = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            checkNetworkStatus();
        });
        
        // Load chat sessions
        async function loadSessions() {
            try {
                const response = await fetch('/api/chat/sessions');
                sessions = await response.json();
                renderSessions();
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        // Render sessions in sidebar
        function renderSessions() {
            const sessionList = document.getElementById('sessionList');
            
            if (sessions.length === 0) {
                sessionList.innerHTML = '<div class="p-3 text-muted text-center">No chat sessions yet</div>';
                return;
            }
            
            sessionList.innerHTML = sessions.map(session => `
                <div class="list-group-item list-group-item-action ${currentSessionId === session.id ? 'active' : ''}" 
                     onclick="loadSession('${session.id}')">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${session.title}</h6>
                        <small>${new Date(session.updated_at).toLocaleDateString()}</small>
                    </div>
                    <small>Messages: ${session.message_count || 0}</small>
                </div>
            `).join('');
        }
        
        // Load a specific session
        async function loadSession(sessionId) {
            currentSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            document.getElementById('chatTitle').textContent = session ? session.title : 'Chat Session';
            
            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}/messages`);
                const messages = await response.json();
                renderMessages(messages);
                renderSessions(); // Update active session highlight
            } catch (error) {
                console.error('Error loading session messages:', error);
            }
        }
        
        // Render messages in chat container
        function renderMessages(messages) {
            const chatContainer = document.getElementById('chatContainer');
            
            if (messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Start your conversation!</p>
                    </div>
                `;
                return;
            }
            
            chatContainer.innerHTML = messages.map(message => `
                <div class="message ${message.role}">
                    <div>${message.content}</div>
                    <small class="opacity-75">
                        ${new Date(message.timestamp).toLocaleTimeString()}
                    </small>
                </div>
            `).join('');
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Create new session
        async function createNewSession() {
            try {
                const response = await fetch('/api/chat/sessions', { method: 'POST' });
                const newSession = await response.json();
                currentSessionId = newSession.id;
                await loadSessions();
                document.getElementById('chatTitle').textContent = newSession.title;
                document.getElementById('chatContainer').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>New conversation started!</p>
                        <p>Type a message to begin.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error creating new session:', error);
            }
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            input.disabled = true;
            document.getElementById('typingIndicator').style.display = 'block';
            
            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });
                
                const result = await response.json();
                currentSessionId = result.session_id;
                
                // Reload the session to show new messages
                await loadSession(currentSessionId);
                await loadSessions(); // Refresh session list
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            } finally {
                input.disabled = false;
                input.focus();
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }
        
        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Check network status
        async function checkNetworkStatus() {
            try {
                const response = await fetch('/api/network/status');
                const status = await response.json();
                updateNetworkStatusIndicator(status);
                await loadNetworkDetails();
            } catch (error) {
                console.error('Error checking network status:', error);
                document.getElementById('networkStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle status-unhealthy me-1"></i>Network Error';
            }
        }
        
        // Update network status indicator
        function updateNetworkStatusIndicator(status) {
            const networkStatus = document.getElementById('networkStatus');
            const statusClass = `status-${status.overall_status}`;
            const icon = status.overall_status === 'healthy' ? 'check' : 
                        status.overall_status === 'degraded' ? 'exclamation-triangle' : 'times';
            
            networkStatus.innerHTML = 
                `<i class="fas fa-${icon} ${statusClass} me-1"></i>${status.reachable_endpoints}/${status.total_endpoints} endpoints`;
        }
        
        // Load detailed network information
        async function loadNetworkDetails() {
            try {
                const response = await fetch('/api/network/test');
                const testResults = await response.json();
                renderNetworkDetails(testResults);
            } catch (error) {
                console.error('Error loading network details:', error);
            }
        }
        
        // Render network details
        function renderNetworkDetails(testResults) {
            const networkDetails = document.getElementById('networkDetails');
            
            networkDetails.innerHTML = `
                <div class="mb-2">
                    <strong>Overall Status:</strong> 
                    <span class="status-${testResults.overall_status}">
                        ${testResults.overall_status.toUpperCase()}
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Endpoints:</strong> ${testResults.reachable_endpoints}/${testResults.total_endpoints}
                </div>
                ${testResults.average_response_time_ms ? 
                    `<div class="mb-2"><strong>Avg Response:</strong> ${testResults.average_response_time_ms.toFixed(1)}ms</div>` : 
                    ''
                }
                <details>
                    <summary>Endpoint Details</summary>
                    <div class="mt-2">
                        ${testResults.test_results.map(result => `
                            <div class="d-flex justify-content-between align-items-center py-1">
                                <span class="small">${result.endpoint}</span>
                                <span class="${result.is_reachable ? 'text-success' : 'text-danger'}">
                                    <i class="fas fa-${result.is_reachable ? 'check' : 'times'}"></i>
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `;
        }
        
        // Run network test manually
        async function runNetworkTest() {
            document.getElementById('networkDetails').innerHTML = 
                '<div class="text-center"><i class="fas fa-circle-notch fa-spin"></i><div>Testing...</div></div>';
            await checkNetworkStatus();
        }
    </script>
</body>
</html>